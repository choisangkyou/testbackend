name: Deploy testbackend to OCI

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  DEPLOY_PATH: /home/opc/testbackend
  APP_NAME: testbackend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # 1ë‹¨ê³„: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      # ==========================================
      # 2ë‹¨ê³„: JDK 17 ì„¤ì • (Gradleìš©)
      # ==========================================
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'  # Gradle ìºì‹œ í™œì„±í™”
      
      # ==========================================
      # 3ë‹¨ê³„: Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬
      # ==========================================
      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew
      
      # ==========================================
      # 4ë‹¨ê³„: Gradle ë¹Œë“œ (ë¡œì»¬ì—ì„œëŠ” ì•ˆí•¨, ì„œë²„ì—ì„œ Dockerë¡œ ë¹Œë“œ)
      # ==========================================
      # ë¡œì»¬ ë¹Œë“œëŠ” ìŠ¤í‚µí•˜ê³  ì†ŒìŠ¤ì½”ë“œë§Œ ì „ì†¡
      # Docker ë‚´ë¶€ì—ì„œ ë¹Œë“œí•˜ëŠ” ê²ƒì´ í™˜ê²½ ì¼ê´€ì„± ìœ ì§€ì— ìœ ë¦¬
      
      # ==========================================
      # 5ë‹¨ê³„: ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
      # ==========================================
      - name: ğŸ“ Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "========================================"
            echo "ğŸ“ Creating deployment directory"
            echo "========================================"
            mkdir -p ${{ env.DEPLOY_PATH }}
            echo "âœ… Directory ready: ${{ env.DEPLOY_PATH }}"
      
      # ==========================================
      # 6ë‹¨ê³„: í”„ë¡œì íŠ¸ íŒŒì¼ ì „ì†¡ (ì „ì²´ ì†ŒìŠ¤)
      # ==========================================
      - name: ğŸ“¤ Transfer project files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "src/,build.gradle,settings.gradle,gradlew,gradlew.bat,gradle/,Dockerfile,docker-compose.yml"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 0
          rm: false
      
      # ==========================================
      # 7ë‹¨ê³„: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      # ==========================================
      - name: ğŸ” Create .env file with secrets
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo "========================================"
            echo "ğŸ” Creating .env file"
            echo "========================================"
            
            cat > .env << 'EOF'
            # Application Settings
            APP_PORT=8080
            SPRING_PROFILES_ACTIVE=prod
            
            # Database Settings
            DB_PORT=3306
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            
            # JPA Settings
            JPA_DDL_AUTO=update
            JPA_SHOW_SQL=false
            EOF
            
            echo "âœ… .env file created successfully"
      
      # ==========================================
      # 8ë‹¨ê³„: ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
      # ==========================================
      - name: ğŸ›‘ Stop existing services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo "========================================"
            echo "ğŸ›‘ Stopping existing containers"
            echo "========================================"
            
            if [ -f docker-compose.yml ]; then
              docker-compose down 2>/dev/null || echo "No containers to stop"
            fi
            
            echo "âœ… Cleanup completed"
      
      # ==========================================
      # 9ë‹¨ê³„: ì´ë¯¸ì§€ ì •ë¦¬
      # ==========================================
      - name: ğŸ§¹ Clean up old Docker images
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "========================================"
            echo "ğŸ§¹ Removing old images"
            echo "========================================"
            docker image prune -af --filter "until=24h" || true
            echo "âœ… Old images removed"
      
      # ==========================================
      # 10ë‹¨ê³„: Docker Compose ë¹Œë“œ ë° ì‹œì‘
      # ==========================================
      - name: ğŸš€ Build and start services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 30m
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo "========================================"
            echo "ğŸ”¨ Building Docker images"
            echo "========================================"
            docker-compose build --no-cache
            
            echo ""
            echo "========================================"
            echo "ğŸš€ Starting services"
            echo "========================================"
            docker-compose up -d
            
            echo ""
            echo "========================================"
            echo "â³ Waiting for services to initialize"
            echo "========================================"
            echo "Waiting 30 seconds for containers to start..."
            sleep 30
            
            echo ""
            echo "========================================"
            echo "ğŸ“Š Current container status"
            echo "========================================"
            docker-compose ps
      
      # ==========================================
      # 11ë‹¨ê³„: í—¬ìŠ¤ì²´í¬ ë° ê²€ì¦
      # ==========================================
      - name: ğŸ¥ Health check and verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo "========================================"
            echo "ğŸ¥ Performing health check"
            echo "========================================"
            
            MAX_ATTEMPTS=20
            ATTEMPT=0
            HEALTH_URL="http://localhost:8080/actuator/health"
            FALLBACK_URL="http://localhost:8080"
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "â³ Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
              if ! docker-compose ps | grep -E "testbackend-app.*Up" > /dev/null; then
                echo "âŒ Application container not running"
                echo ""
                echo "Container status:"
                docker-compose ps
                echo ""
                echo "Application logs:"
                docker-compose logs --tail=50 app
                exit 1
              fi
              
              # Actuator í—¬ìŠ¤ì²´í¬ ì‹œë„
              if curl -f -s "$HEALTH_URL" > /dev/null 2>&1; then
                echo ""
                echo "========================================"
                echo "âœ… APPLICATION IS HEALTHY!"
                echo "========================================"
                echo ""
                curl -s "$HEALTH_URL" | jq '.' 2>/dev/null || curl -s "$HEALTH_URL"
                echo ""
                echo "ğŸ“„ Recent application logs:"
                docker-compose logs --tail=30 app
                echo ""
                echo "ğŸ“Š Container status:"
                docker-compose ps
                echo ""
                echo "ğŸ’» Resource usage:"
                docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" testbackend-app testbackend-db 2>/dev/null || echo "Stats not available"
                echo ""
                echo "========================================"
                echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
                echo "========================================"
                echo "ğŸŒ Application URL: http://${{ secrets.DEPLOY_HOST }}:8080"
                echo "ğŸ¥ Health Check: http://${{ secrets.DEPLOY_HOST }}:8080/actuator/health"
                echo "ğŸ’¾ Database: ${{ secrets.DEPLOY_HOST }}:3306"
                echo "========================================"
                exit 0
              fi
              
              # Actuatorê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ URL í™•ì¸
              if curl -f -s "$FALLBACK_URL" > /dev/null 2>&1; then
                echo ""
                echo "========================================"
                echo "âœ… APPLICATION IS RESPONDING!"
                echo "========================================"
                echo "âš ï¸ Note: Actuator health endpoint not available"
                echo ""
                echo "ğŸ“„ Recent application logs:"
                docker-compose logs --tail=30 app
                echo ""
                echo "ğŸ“Š Container status:"
                docker-compose ps
                echo ""
                echo "========================================"
                echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
                echo "========================================"
                echo "ğŸŒ Application URL: http://${{ secrets.DEPLOY_HOST }}:8080"
                echo "========================================"
                exit 0
              fi
              
              echo "Application not ready yet, waiting..."
              sleep 10
            done
            
            # ìµœì¢… ì‹¤íŒ¨
            echo ""
            echo "========================================"
            echo "âŒ DEPLOYMENT FAILED"
            echo "========================================"
            echo "âš ï¸ Application did not become healthy within expected time"
            echo ""
            echo "ğŸ“„ Full application logs:"
            docker-compose logs app
            echo ""
            echo "ğŸ“„ Database logs:"
            docker-compose logs db
            echo ""
            echo "ğŸ“Š Container status:"
            docker-compose ps -a
            echo ""
            echo "ğŸ” Network status:"
            docker network ls
            echo ""
            echo "========================================"
            exit 1
      
      # ==========================================
      # 12ë‹¨ê³„: ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (ì„±ê³µ ì‹œ)
      # ==========================================
      - name: ğŸ“¢ Deployment summary
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            echo ""
            echo "============================================"
            echo "           ğŸŠ DEPLOYMENT SUMMARY ğŸŠ"
            echo "============================================"
            echo ""
            echo "ğŸ“… Deployment Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "ğŸŒ Application: http://${{ secrets.DEPLOY_HOST }}:8080"
            echo "ğŸ’¾ Database: ${{ secrets.DEPLOY_HOST }}:3306"
            echo ""
            echo "ğŸ“¦ Running Containers:"
            docker ps --filter "name=testbackend" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "ğŸ’¿ Disk Usage:"
            df -h ${{ env.DEPLOY_PATH }} | tail -n 1
            echo ""
            echo "============================================"
            echo "âœ… All systems operational!"
            echo "============================================"
